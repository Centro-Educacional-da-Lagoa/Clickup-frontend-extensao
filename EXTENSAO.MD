# ğŸ”Œ Como Conectar a ExtensÃ£o com o Backend

## ğŸ“ Estrutura da ExtensÃ£o

```
sua-extensao/
â”œâ”€â”€ manifest.json
â”œâ”€â”€ popup.html
â”œâ”€â”€ popup.js
â””â”€â”€ background.js (opcional)
```

---

## 1ï¸âƒ£ manifest.json

```json
{
  "manifest_version": 3,
  "name": "ClickUp Extension",
  "version": "1.0",
  "description": "ExtensÃ£o ClickUp com OAuth",
  "permissions": [
    "storage"
  ],
  "host_permissions": [
    "http://localhost:3000/*",
    "https://*.clickup.com/*"
  ],
  "action": {
    "default_popup": "popup.html",
    "default_icon": "icon.png"
  }
}
```

---

## 2ï¸âƒ£ popup.html

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      width: 300px;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    .status {
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .connected {
      background: #d4edda;
      color: #155724;
    }
    .disconnected {
      background: #f8d7da;
      color: #721c24;
    }
    button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      font-size: 14px;
    }
    .connect-btn {
      background: #7B68EE;
      color: white;
    }
    .connect-btn:hover {
      background: #6A5ACD;
    }
    .disconnect-btn {
      background: #dc3545;
      color: white;
    }
    #tokenDisplay {
      font-size: 10px;
      word-break: break-all;
      padding: 5px;
      background: #f0f0f0;
      margin: 10px 0;
      max-height: 60px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h2>ğŸš€ ClickUp OAuth</h2>
  
  <div id="status" class="status disconnected">
    âŒ NÃ£o conectado
  </div>

  <div id="tokenInfo" style="display: none;">
    <strong>Token:</strong>
    <div id="tokenDisplay"></div>
  </div>

  <button id="connectBtn" class="connect-btn">
    ğŸ” Conectar com ClickUp
  </button>

  <button id="disconnectBtn" class="disconnect-btn" style="display: none;">
    ğŸ”“ Desconectar
  </button>

  <button id="testBtn" style="display: none; background: #28a745; color: white;">
    ğŸ§ª Testar API
  </button>

  <div id="result" style="margin-top: 10px;"></div>

  <script src="popup.js"></script>
</body>
</html>
```

---

## 3ï¸âƒ£ popup.js

```javascript
// URL do seu backend (altere para ngrok em produÃ§Ã£o)
const BACKEND_URL = 'http://localhost:3000';

// Elementos DOM
const statusDiv = document.getElementById('status');
const tokenInfo = document.getElementById('tokenInfo');
const tokenDisplay = document.getElementById('tokenDisplay');
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const testBtn = document.getElementById('testBtn');
const resultDiv = document.getElementById('result');

// Verifica se jÃ¡ estÃ¡ conectado ao carregar
checkConnection();

// BotÃ£o de Conectar
connectBtn.addEventListener('click', () => {
  // Abre popup OAuth
  const authWindow = window.open(
    `${BACKEND_URL}/auth/clickup`,
    'ClickUp OAuth',
    'width=600,height=700'
  );

  // Escuta mensagem do backend
  window.addEventListener('message', handleOAuthCallback);
});

// BotÃ£o de Desconectar
disconnectBtn.addEventListener('click', () => {
  chrome.storage.sync.remove('clickupToken', () => {
    updateUI(false);
    resultDiv.textContent = 'âœ… Desconectado com sucesso!';
    setTimeout(() => resultDiv.textContent = '', 3000);
  });
});

// BotÃ£o de Testar API
testBtn.addEventListener('click', async () => {
  chrome.storage.sync.get('clickupToken', async (data) => {
    if (data.clickupToken) {
      try {
        resultDiv.textContent = 'â³ Testando...';
        
        // Testa API do ClickUp - busca informaÃ§Ãµes do usuÃ¡rio
        const response = await fetch('https://api.clickup.com/api/v2/user', {
          headers: {
            'Authorization': data.clickupToken
          }
        });

        if (response.ok) {
          const userData = await response.json();
          resultDiv.innerHTML = `
            âœ… API funcionando!<br>
            <strong>UsuÃ¡rio:</strong> ${userData.user.username}<br>
            <strong>Email:</strong> ${userData.user.email}
          `;
        } else {
          resultDiv.textContent = 'âŒ Erro ao testar API';
        }
      } catch (error) {
        resultDiv.textContent = `âŒ Erro: ${error.message}`;
      }
    }
  });
});

// FunÃ§Ã£o que recebe o token do backend
function handleOAuthCallback(event) {
  // Verifica se Ã© a mensagem correta
  if (event.data.type === 'CLICKUP_TOKEN_RECEIVED') {
    const token = event.data.token;
    
    // Salva o token no Chrome Storage
    chrome.storage.sync.set({ clickupToken: token }, () => {
      console.log('âœ… Token salvo:', token);
      updateUI(true, token);
      resultDiv.textContent = 'âœ… Conectado com sucesso!';
      setTimeout(() => resultDiv.textContent = '', 3000);
    });

    // Remove o listener apÃ³s receber
    window.removeEventListener('message', handleOAuthCallback);
  }
}

// Verifica se jÃ¡ existe token salvo
function checkConnection() {
  chrome.storage.sync.get('clickupToken', (data) => {
    if (data.clickupToken) {
      updateUI(true, data.clickupToken);
    } else {
      updateUI(false);
    }
  });
}

// Atualiza interface baseado no status
function updateUI(connected, token = '') {
  if (connected) {
    statusDiv.textContent = 'âœ… Conectado';
    statusDiv.className = 'status connected';
    connectBtn.style.display = 'none';
    disconnectBtn.style.display = 'block';
    testBtn.style.display = 'block';
    tokenInfo.style.display = 'block';
    tokenDisplay.textContent = token;
  } else {
    statusDiv.textContent = 'âŒ NÃ£o conectado';
    statusDiv.className = 'status disconnected';
    connectBtn.style.display = 'block';
    disconnectBtn.style.display = 'none';
    testBtn.style.display = 'none';
    tokenInfo.style.display = 'none';
  }
}
```

---

## ğŸš€ Como Usar

### 1. **Adicione os arquivos acima na sua extensÃ£o**

### 2. **Carregue a extensÃ£o no Chrome:**
   - Abra `chrome://extensions/`
   - Ative "Modo do desenvolvedor"
   - Clique em "Carregar sem compactaÃ§Ã£o"
   - Selecione a pasta da extensÃ£o

### 3. **Inicie o backend:**
   ```bash
   npm start
   ```

### 4. **Teste:**
   - Clique no Ã­cone da extensÃ£o
   - Clique em "ğŸ” Conectar com ClickUp"
   - Autorize no ClickUp
   - O token serÃ¡ salvo automaticamente!
   - Clique em "ğŸ§ª Testar API" para verificar

---

## ğŸŒ Para usar com ngrok (Internet):

1. **Instale ngrok:**
   ```bash
   npm install -g ngrok
   ```

2. **Inicie ngrok:**
   ```bash
   ngrok http 3000
   ```

3. **Atualize o .env com a URL do ngrok:**
   ```
   CLICKUP_REDIRECT_URI=https://sua-url.ngrok.io/auth/clickup/callback
   ```

4. **Atualize tambÃ©m no painel do ClickUp:**
   - VÃ¡ em https://app.clickup.com/settings/apps
   - Edite sua app OAuth
   - Adicione a redirect URI do ngrok

5. **Atualize o popup.js:**
   ```javascript
   const BACKEND_URL = 'https://sua-url.ngrok.io';
   ```

---

## ğŸ“ Como Usar o Token nas RequisiÃ§Ãµes

Depois de conectado, use o token em qualquer requisiÃ§Ã£o:

```javascript
chrome.storage.sync.get('clickupToken', async (data) => {
  if (data.clickupToken) {
    const response = await fetch('https://api.clickup.com/api/v2/team', {
      headers: {
        'Authorization': data.clickupToken
      }
    });
    const teams = await response.json();
    console.log(teams);
  }
});
```

---

## âœ… Pronto!

Agora sua extensÃ£o estÃ¡ conectada ao backend e pode usar a API do ClickUp sem pedir o token manualmente ao usuÃ¡rio! ğŸ‰
